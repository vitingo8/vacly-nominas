'use client'

import { useState, useEffect } from 'react'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Progress } from '@/components/ui/progress'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Badge } from '@/components/ui/badge'
import { Upload, FileText, Download, Eye, FileImage, Type, Brain, CheckCircle, FileSpreadsheet, Zap, Database, TrendingUp, Clock, Hash, Settings, AlertCircle, Star, Sparkles, Loader2, Shield, Rocket, Users, BarChart3, Lock, Award, ChevronRight, ArrowRight } from 'lucide-react'
import { PricingBanner } from '@/components/ui/pricing-banner'

interface NominaData {
  id: string
  nominaId: string
  period_start: string
  period_end: string
  employee: {
    name?: string
    dni?: string
    nss?: string
    category?: string
    code?: string
  }
  company: {
    name?: string
    cif?: string
    address?: string
    center_code?: string
  }
  perceptions: Array<{
    code?: string
    concept?: string
    amount?: number
  }>
  deductions: Array<{
    code?: string
    concept?: string
    amount?: number
  }>
  contributions: Array<{
    concept?: string
    base?: number
    rate?: number
    employer_contribution?: number
  }>
  base_ss: number
  net_pay: number
  iban?: string
  swift_bic?: string
  cost_empresa: number
  signed: boolean
}

interface SplitDocument {
  id: string
  filename: string
  pageNumber: number
  textContent: string
  pdfPath: string
  textPath: string
  claudeProcessed?: boolean
  nominaData?: NominaData
  pdfUrl: string
  textUrl: string
}

type ViewMode = 'pdf' | 'text'

export default function Home() {
  const [isUploading, setIsUploading] = useState(false)
  const [uploadProgress, setUploadProgress] = useState(0)
  const [progressMessage, setProgressMessage] = useState('')
  const [currentPage, setCurrentPage] = useState<number | null>(null)
  const [totalPages, setTotalPages] = useState<number | null>(null)
  const [splitDocuments, setSplitDocuments] = useState<SplitDocument[]>([])
  const [selectedDocument, setSelectedDocument] = useState<SplitDocument | null>(null)
  const [isViewerOpen, setIsViewerOpen] = useState(false)
  const [viewerDocument, setViewerDocument] = useState<SplitDocument | null>(null)
  const [viewMode, setViewMode] = useState<ViewMode>('pdf')
  const [isProcessingClaude, setIsProcessingClaude] = useState<string | null>(null)
  const [isBatchProcessing, setIsBatchProcessing] = useState(false)
  const [isExportingExcel, setIsExportingExcel] = useState(false)
  const [batchProgress, setBatchProgress] = useState(0)
  const [memoryStatus, setMemoryStatus] = useState<any>(null)
  const [isLoadingMemory, setIsLoadingMemory] = useState(false)
  const [memoryMode, setMemoryMode] = useState<'basic' | 'enterprise'>('basic')
  const [showMemoryConfig, setShowMemoryConfig] = useState(false)
  const [isDeletingMemory, setIsDeletingMemory] = useState(false)

  // Load memory status on component mount
  useEffect(() => {
    if (memoryMode === 'enterprise') {
      loadMemoryStatus()
    }
  }, [memoryMode])

  const loadMemoryStatus = async () => {
    if (memoryMode !== 'enterprise') return
    
    setIsLoadingMemory(true)
    try {
      const response = await fetch('/api/memory-status')
      const result = await response.json()
      
      if (response.ok) {
        setMemoryStatus(result.data)
      } else {
        console.error('Error loading memory status:', result.error)
        setMemoryStatus(null)
      }
    } catch (error) {
      console.error('Error loading memory status:', error)
      setMemoryStatus(null)
    } finally {
      setIsLoadingMemory(false)
    }
  }

  const deleteMemoryData = async (type: string, patternId?: string) => {
    const confirmMessages = {
      'all': '¬øEst√°s seguro de que quieres eliminar TODA la memoria empresarial? Esta acci√≥n no se puede deshacer.',
      'patterns': '¬øQuieres eliminar todos los patrones aprendidos? Esto har√° que el sistema olvide las estructuras espec√≠ficas de tus n√≥minas.',
      'embeddings': '¬øQuieres eliminar el √≠ndice de b√∫squeda sem√°ntica? Esto eliminar√° la capacidad de encontrar documentos similares.',
      'documents': '¬øQuieres eliminar el historial de documentos procesados?'
    }

    const message = patternId ? 
      '¬øQuieres eliminar este patr√≥n espec√≠fico de la memoria?' : 
      confirmMessages[type as keyof typeof confirmMessages]

    if (!confirm(message)) return

    setIsDeletingMemory(true)
    try {
      const url = patternId ? 
        `/api/memory-status?type=pattern&patternId=${patternId}` :
        `/api/memory-status?type=${type}`

      const response = await fetch(url, {
        method: 'DELETE'
      })

      const result = await response.json()

      if (response.ok) {
        alert('‚úÖ Datos eliminados exitosamente')
        loadMemoryStatus() // Refresh the data
      } else {
        alert(`‚ùå Error: ${result.error}`)
      }
    } catch (error) {
      console.error('Error deleting memory data:', error)
      alert('‚ùå Error al eliminar los datos')
    } finally {
      setIsDeletingMemory(false)
    }
  }

  // Helper function to generate business insights from memory data
  const generateBusinessInsights = (memoryStatus: any) => {
    if (!memoryStatus || !memoryStatus.summary) return []

    const insights = []
    const patterns = memoryStatus.memory_patterns || []
    const totalDocs = memoryStatus.summary?.total_processed || 0
    const totalEmbeddings = memoryStatus.summary?.total_embeddings || 0

    // Company structure insights
    if (patterns.length > 0) {
      const companies = patterns
        .map((p: any) => p.extracted_data?.company?.name)
        .filter(Boolean)
      const uniqueCompanies = [...new Set(companies)]
      if (uniqueCompanies.length > 0) {
        insights.push({
          icon: 'üè¢',
          title: 'Empresas Reconocidas',
          description: `Hemos aprendido la estructura de n√≥minas de ${uniqueCompanies.length} empresa(s)`,
          details: uniqueCompanies.slice(0, 3).join(', ') + (uniqueCompanies.length > 3 ? '...' : ''),
          value: `${uniqueCompanies.length} empresa(s)`,
          type: 'companies'
        })
      }
    }

    // Document processing speed
    if (totalDocs > 5) {
      const avgProcessingTime = totalDocs > 10 ? '5-8 segundos' : '8-15 segundos'
      insights.push({
        icon: '‚ö°',
        title: 'Velocidad de Procesamiento',
        description: `Cada nuevo documento se procesa en ${avgProcessingTime} gracias a la memoria`,
        details: 'La velocidad mejora autom√°ticamente con cada documento procesado',
        value: avgProcessingTime,
        type: 'speed'
      })
    }

    // Pattern recognition
    if (patterns.length > 0) {
      const keywords = patterns
        .flatMap((p: any) => p.keywords || [])
        .filter(Boolean)
      const uniqueKeywords = [...new Set(keywords)].slice(0, 5)
      if (uniqueKeywords.length > 0) {
        insights.push({
          icon: 'üß†',
          title: 'T√©rminos Empresariales Aprendidos',
          description: `Reconocemos autom√°ticamente ${uniqueKeywords.length} t√©rminos espec√≠ficos de tu empresa`,
          details: uniqueKeywords.join(', '),
          value: `${uniqueKeywords.length} t√©rminos`,
          type: 'keywords'
        })
      }
    }

    // Document similarity
    if (totalEmbeddings > 20) {
      const docsWithEmbeddings = Math.ceil(totalEmbeddings / 7)
      insights.push({
        icon: 'üîç',
        title: 'B√∫squeda Inteligente',
        description: `Podemos encontrar documentos similares entre ${docsWithEmbeddings} n√≥minas procesadas`,
        details: 'Esto acelera el procesamiento al reutilizar patrones conocidos',
        value: `${docsWithEmbeddings} documentos indexados`,
        type: 'search'
      })
    }

    // Accuracy improvement
    const avgConfidence = memoryStatus.summary?.avg_confidence || 0.5
    if (avgConfidence > 0.7) {
      insights.push({
        icon: 'üéØ',
        title: 'Precisi√≥n Mejorada',
        description: `La precisi√≥n ha mejorado al ${Math.round(avgConfidence * 100)}% gracias al aprendizaje`,
        details: 'Cada documento procesado mejora la precisi√≥n del siguiente',
        value: `${Math.round(avgConfidence * 100)}% precisi√≥n`,
        type: 'accuracy'
      })
    }

    return insights
  }

  const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0]
    if (!file || file.type !== 'application/pdf') {
      alert('Por favor selecciona un archivo PDF')
      return
    }

    setIsUploading(true)
    setUploadProgress(0)
    setProgressMessage('Iniciando carga...')
    setCurrentPage(null)
    setTotalPages(null)

    const formData = new FormData()
    formData.append('pdf', file)

    try {
      // Phase 1: Upload the file (0-20%)
      setUploadProgress(5)
      setProgressMessage('Subiendo archivo PDF...')
      
      const uploadResponse = await fetch('/api/upload', {
        method: 'POST',
        body: formData,
      })

      if (!uploadResponse.ok) {
        throw new Error('Error al subir el archivo')
      }

      const uploadResult = await uploadResponse.json()
      setUploadProgress(20)
      setProgressMessage('Archivo subido, iniciando procesamiento...')

      // Try to use the new progress API first
      let processedSuccessfully = false
      
      try {
        // Phase 2: Process with real-time progress using fetch stream (20-100%)
        const processResponse = await fetch('/api/process-with-progress', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            filename: uploadResult.filename,
            url: uploadResult.url 
          }),
        })

        if (processResponse.ok) {
          // Handle the Server-Sent Events stream
          const reader = processResponse.body?.getReader()
          const decoder = new TextDecoder()

          if (reader) {
            let buffer = ''
            
            while (true) {
              const { done, value } = await reader.read()
              
              if (done) break

              const chunk = decoder.decode(value, { stream: true })
              buffer += chunk
              
              // Split by double newlines to get complete SSE messages
              const messages = buffer.split('\n\n')
              buffer = messages.pop() || '' // Keep the incomplete message in buffer

              for (const message of messages) {
                const lines = message.split('\n')
                
                for (const line of lines) {
                  if (line.startsWith('data: ')) {
                    try {
                      const data = JSON.parse(line.slice(6))
                      
                      if (data.type === 'progress') {
                        setUploadProgress(Math.max(20, data.progress)) // Ensure we don't go below 20%
                        setProgressMessage(data.message)
                        if (data.currentPage !== undefined) {
                          setCurrentPage(data.currentPage)
                        }
                        if (data.totalPages !== undefined) {
                          setTotalPages(data.totalPages)
                        }
                      } else if (data.type === 'complete') {
                        setUploadProgress(100)
                        setProgressMessage('¬°Procesamiento completado!')
                        setSplitDocuments(data.documents)
                        processedSuccessfully = true
                        
                        // Reset progress after a short delay
                        setTimeout(() => {
                          setUploadProgress(0)
                          setProgressMessage('')
                          setCurrentPage(null)
                          setTotalPages(null)
                        }, 2000)
                        return // Exit the function successfully
                      } else if (data.type === 'error') {
                        throw new Error(data.error)
                      }
                    } catch (parseError) {
                      console.error('Error parsing SSE data:', parseError, 'Line:', line)
                    }
                  }
                }
              }
            }
          }
        }
      } catch (progressApiError) {
        console.warn('Progress API failed, falling back to basic processing:', progressApiError)
      }

      // Fallback to original API if progress API failed
      if (!processedSuccessfully) {
        setProgressMessage('Procesamiento con API b√°sica...')
        setUploadProgress(50)
        
        const fallbackResponse = await fetch('/api/process', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            filename: uploadResult.filename,
            url: uploadResult.url 
          }),
        })

        if (!fallbackResponse.ok) {
          throw new Error('Error al procesar el archivo con API b√°sica')
        }

        setUploadProgress(80)
        const fallbackResult = await fallbackResponse.json()
        setUploadProgress(100)
        setProgressMessage('¬°Procesamiento completado!')
        
        setSplitDocuments(fallbackResult.documents)

        // Reset progress after a short delay
        setTimeout(() => {
          setUploadProgress(0)
          setProgressMessage('')
          setCurrentPage(null)
          setTotalPages(null)
        }, 2000)
      }

    } catch (error) {
      console.error('Error:', error)
      alert('Ocurri√≥ un error durante la carga o procesamiento: ' + (error instanceof Error ? error.message : 'Error desconocido'))
      
      // Reset progress on error
      setUploadProgress(0)
      setProgressMessage('')
      setCurrentPage(null)
      setTotalPages(null)
    } finally {
      setIsUploading(false)
    }
  }

  const downloadFile = async (url: string, filename: string) => {
    try {
      const response = await fetch(url)
      if (!response.ok) throw new Error('Error al descargar')
      
      const blob = await response.blob()
      const objectUrl = URL.createObjectURL(blob)
      
      const link = document.createElement('a')
      link.href = objectUrl
      link.download = filename
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      
      URL.revokeObjectURL(objectUrl)
    } catch (error) {
      console.error('Error de descarga:', error)
      alert('Error al descargar el archivo')
    }
  }

  const openViewer = (document: SplitDocument) => {
    setViewerDocument(document)
    setIsViewerOpen(true)
    setViewMode('pdf') // Default to PDF view
  }

  const processWithClaude = async (document: SplitDocument) => {
    if (!document.textContent.trim()) {
      alert('No se encontr√≥ contenido de texto en este documento para procesar')
      return
    }

    setIsProcessingClaude(document.id)

    try {
      // Choose endpoint based on memory mode
      const endpoint = memoryMode === 'enterprise' ? '/api/process-nomina' : '/api/process-nomina-basic'
      
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          textContent: document.textContent,
          documentId: document.id
        }),
      })

      const result = await response.json()

      if (!response.ok) {
        throw new Error(result.error || 'Error al procesar con Claude')
      }

      // Update the document with processed data
      setSplitDocuments(prevDocs => 
        prevDocs.map(doc => 
          doc.id === document.id 
            ? { 
                ...doc, 
                claudeProcessed: true, 
                nominaData: result.data 
              }
            : doc
        )
      )

      // Update viewer document if it's the same one
      if (viewerDocument?.id === document.id) {
        setViewerDocument({
          ...viewerDocument,
          claudeProcessed: true,
          nominaData: result.data
        })
      }

      // Update selected document if it's the same one
      if (selectedDocument?.id === document.id) {
        setSelectedDocument({
          ...selectedDocument,
          claudeProcessed: true,
          nominaData: result.data
        })
      }

      // Refresh memory status only if in enterprise mode
      if (memoryMode === 'enterprise') {
        loadMemoryStatus()
      }

      // Show different success messages based on mode
      const successMessage = memoryMode === 'enterprise' 
        ? '¬°N√≥mina procesada y guardada exitosamente! üß† La memoria empresarial se ha actualizado autom√°ticamente.'
        : '¬°N√≥mina procesada y guardada exitosamente! ‚ö° Procesamiento b√°sico completado.'
      
      alert(successMessage)

    } catch (error) {
      console.error('Error procesando con Claude:', error)
      alert(`Error: ${error instanceof Error ? error.message : 'Error desconocido'}`)
    } finally {
      setIsProcessingClaude(null)
    }
  }

  const processBatchWithClaude = async () => {
    const unprocessedDocs = splitDocuments.filter(doc => !doc.claudeProcessed)
    
    if (unprocessedDocs.length === 0) {
      alert('No hay documentos sin procesar')
      return
    }

    setIsBatchProcessing(true)
    setBatchProgress(0)

    try {
      // Choose endpoint based on memory mode
      const endpoint = memoryMode === 'enterprise' ? '/api/process-nomina' : '/api/process-nomina-basic'
      
      // Process documents in parallel batches of 3 to avoid overwhelming the API
      const batchSize = 3
      const results: any[] = []
      const errors: any[] = []

      for (let i = 0; i < unprocessedDocs.length; i += batchSize) {
        const batch = unprocessedDocs.slice(i, i + batchSize)
        setBatchProgress(Math.round((i / unprocessedDocs.length) * 100))

        // Process batch in parallel
        const batchPromises = batch.map(async (doc) => {
          try {
            const response = await fetch(endpoint, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                textContent: doc.textContent,
                documentId: doc.id
              }),
            })

            const result = await response.json()

            if (response.ok) {
              return {
                documentId: doc.id,
                success: true,
                data: result.data
              }
            } else {
              return {
                documentId: doc.id,
                success: false,
                filename: doc.filename,
                error: result.error
              }
            }
          } catch (error) {
            return {
              documentId: doc.id,
              success: false,
              filename: doc.filename,
              error: error instanceof Error ? error.message : 'Error desconocido'
            }
          }
        })

        // Wait for all requests in this batch to complete
        const batchResults = await Promise.all(batchPromises)
        
        // Process results
        batchResults.forEach(result => {
          if (result.success) {
            results.push(result)
            // Update the document immediately
            setSplitDocuments(prevDocs => 
              prevDocs.map(prevDoc => 
                prevDoc.id === result.documentId 
                  ? { 
                      ...prevDoc, 
                      claudeProcessed: true, 
                      nominaData: result.data 
                    }
                  : prevDoc
              )
            )
          } else {
            errors.push(result)
          }
        })

        // Small delay between batches to be respectful to the API
        if (i + batchSize < unprocessedDocs.length) {
          await new Promise(resolve => setTimeout(resolve, 500))
        }
      }

      setBatchProgress(100)

      // Refresh memory status only if in enterprise mode
      if (memoryMode === 'enterprise') {
        loadMemoryStatus()
      }

      // Show results
      const successCount = results.length
      const errorCount = errors.length
      
      let message = `‚úÖ Procesamiento completado:\n`
      message += `- ${successCount} documentos procesados exitosamente\n`
      
      if (errorCount > 0) {
        message += `- ${errorCount} documentos con errores\n\n`
        message += `Errores:\n`
        errors.forEach(err => {
          message += `- ${err.filename}: ${err.error}\n`
        })
      }

      if (memoryMode === 'enterprise') {
        message += '\nüß† La memoria empresarial se ha actualizado con los nuevos patrones.'
      }

      alert(message)

    } catch (error) {
      console.error('Error en procesamiento por lotes:', error)
      alert(`Error: ${error instanceof Error ? error.message : 'Error desconocido'}`)
    } finally {
      setIsBatchProcessing(false)
      setBatchProgress(0)
    }
  }

  const exportToExcel = async () => {
    const processedDocs = splitDocuments.filter(doc => doc.claudeProcessed && doc.nominaData)
    
    if (processedDocs.length === 0) {
      alert('No hay documentos procesados para exportar')
      return
    }

    setIsExportingExcel(true)

    try {
      const response = await fetch('/api/export-excel', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          documents: processedDocs.map(doc => ({
            filename: doc.filename,
            pageNumber: doc.pageNumber,
            nominaData: doc.nominaData
          }))
        }),
      })

      if (!response.ok) {
        throw new Error('Error al exportar a Excel')
      }

      const blob = await response.blob()
      const url = URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = url
      link.download = `nominas_procesadas_${new Date().toISOString().split('T')[0]}.xlsx`
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      URL.revokeObjectURL(url)

    } catch (error) {
      console.error('Error exportando a Excel:', error)
      alert('Error al exportar a Excel')
    } finally {
      setIsExportingExcel(false)
    }
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
      {/* Header */}
      <header className="bg-white shadow-soft border-b">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-6">
            <div className="flex items-center space-x-4">
              <div className="flex items-center space-x-2">
                <FileSpreadsheet className="h-8 w-8 text-primary" />
                <h1 className="text-2xl font-bold text-gray-900">Vacly N√≥minas</h1>
              </div>
              <Badge variant="secondary" className="text-xs">
                Sistema Inteligente de Gesti√≥n
              </Badge>
            </div>
            
            <div className="flex items-center space-x-4">
              {/* Memory Mode Toggle */}
              <div className="flex items-center space-x-2 bg-gray-100 rounded-lg p-1">
                <button
                  onClick={() => setMemoryMode('basic')}
                  className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                    memoryMode === 'basic' 
                      ? 'bg-white text-gray-900 shadow-sm' 
                      : 'text-gray-600 hover:text-gray-900'
                  }`}
                >
                  <div className="flex items-center space-x-2">
                    <Zap className="h-4 w-4" />
                    <span>B√°sico</span>
                  </div>
                </button>
                <button
                  onClick={() => setMemoryMode('enterprise')}
                  className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                    memoryMode === 'enterprise' 
                      ? 'bg-gradient-to-r from-purple-600 to-primary text-white shadow-sm' 
                      : 'text-gray-600 hover:text-gray-900'
                  }`}
                >
                  <div className="flex items-center space-x-2">
                    <Brain className="h-4 w-4" />
                    <span>Memoria</span>
                  </div>
                </button>
              </div>

              {memoryMode === 'enterprise' && (
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setShowMemoryConfig(!showMemoryConfig)}
                  className="flex items-center space-x-2"
                >
                  <Settings className="h-4 w-4" />
                  <span>Configurar</span>
                </Button>
              )}
            </div>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Mode Switch Notification */}
        {memoryMode === 'enterprise' && splitDocuments.length === 0 && (
          <div className="mb-6 bg-primary/10 border border-primary/100 rounded-lg p-4">
            <div className="flex items-center space-x-3">
              <div className="bg-primary/10 rounded-full p-2">
                <Brain className="h-5 w-5 text-primary" />
              </div>
              <div className="flex-1">
                <h3 className="text-sm font-semibold text-primary">
                  Modo Memoria Empresarial Activado
                </h3>
                <p className="text-sm text-primary mt-1">
                  Tu sistema comenzar√° a aprender autom√°ticamente cuando proceses documentos. 
                  Cada n√≥mina mejorar√° la precisi√≥n y velocidad del siguiente procesamiento.
                </p>
              </div>
              <Badge className="bg-primary text-white">
                <Sparkles className="h-3 w-3 mr-1" />
                PREMIUM
              </Badge>
            </div>
          </div>
        )}

        {/* Memory Benefits Banner */}
        {memoryMode === 'enterprise' && (
          <div className="mb-8 bg-gradient-to-r from-purple-600 to-primary rounded-2xl p-8 text-white shadow-premium">
            <div className="flex items-start justify-between">
              <div className="flex-1">
                <div className="flex items-center space-x-3 mb-4">
                  <Brain className="h-10 w-10" />
                  <h2 className="text-3xl font-bold">Memoria Empresarial Activa</h2>
                  <Badge className="badge-premium">PREMIUM</Badge>
                </div>
                <p className="text-lg mb-6 text-primary/10">
                  Tu sistema aprende y mejora con cada n√≥mina procesada. La IA reconoce patrones espec√≠ficos de tu empresa.
                </p>
                
                {/* Key Benefits */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                  <div className="bg-white/20 backdrop-blur-sm rounded-lg p-4">
                    <div className="flex items-center space-x-2 mb-2">
                      <Rocket className="h-5 w-5" />
                      <span className="font-semibold">80% m√°s r√°pido</span>
                    </div>
                    <p className="text-sm text-primary/10">Procesamiento acelerado con patrones aprendidos</p>
                  </div>
                  <div className="bg-white/20 backdrop-blur-sm rounded-lg p-4">
                    <div className="flex items-center space-x-2 mb-2">
                      <Shield className="h-5 w-5" />
                      <span className="font-semibold">99% precisi√≥n</span>
                    </div>
                    <p className="text-sm text-primary/10">Reconocimiento exacto de tu estructura</p>
                  </div>
                  <div className="bg-white/20 backdrop-blur-sm rounded-lg p-4">
                    <div className="flex items-center space-x-2 mb-2">
                      <TrendingUp className="h-5 w-5" />
                      <span className="font-semibold">Mejora continua</span>
                    </div>
                    <p className="text-sm text-primary/10">Cada documento mejora el sistema</p>
                  </div>
                </div>

                {/* Memory Status Summary */}
                {memoryStatus && (
                  <div className="flex items-center space-x-6 text-sm">
                    <div className="flex items-center space-x-2">
                      <Database className="h-4 w-4" />
                      <span>{memoryStatus.summary?.total_processed || 0} documentos aprendidos</span>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Brain className="h-4 w-4" />
                      <span>{memoryStatus.memory_patterns?.length || 0} patrones reconocidos</span>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Award className="h-4 w-4" />
                      <span>{Math.round((memoryStatus.summary?.avg_confidence || 0.5) * 100)}% confianza</span>
                    </div>
                  </div>
                )}
              </div>
              
              <div className="ml-8 hidden lg:block">
                <div className="animate-float">
                  <Brain className="h-32 w-32 text-white/20" />
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Upload Section */}
        <Card className="mb-8 shadow-soft card-hover">
          <CardHeader className="bg-gradient-to-r from-primary/10 to-indigo-50 rounded-t-lg">
            <CardTitle className="text-2xl flex items-center space-x-3">
              <Upload className="h-6 w-6 text-primary" />
              <span>Cargar N√≥minas</span>
            </CardTitle>
            <CardDescription className="text-base mt-2">
              Sube tus archivos PDF de n√≥minas para procesarlos autom√°ticamente
            </CardDescription>
          </CardHeader>
          <CardContent className="p-8">
            <div className="space-y-6">
              <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-primary/100 transition-colors">
                <Input
                  type="file"
                  accept=".pdf"
                  onChange={handleFileUpload}
                  disabled={isUploading}
                  className="hidden"
                  id="file-upload"
                />
                <Label
                  htmlFor="file-upload"
                  className="cursor-pointer flex flex-col items-center space-y-4"
                >
                  <div className="p-4 bg-primary/10 rounded-full">
                    <Upload className="h-8 w-8 text-primary" />
                  </div>
                  <div>
                    <p className="text-lg font-medium text-gray-900">
                      {isUploading ? 'Procesando...' : 'Haz clic para seleccionar un archivo'}
                    </p>
                    <p className="text-sm text-gray-500 mt-1">
                      o arrastra y suelta un PDF aqu√≠
                    </p>
                  </div>
                  <p className="text-xs text-gray-400">
                    M√°ximo 50MB por archivo
                  </p>
                </Label>
              </div>

              {uploadProgress > 0 && (
                <div className="space-y-3">
                  <div className="flex justify-between text-sm">
                    <span className="text-gray-600">
                      {progressMessage || 'Progreso de carga'}
                    </span>
                    <span className="font-medium">{uploadProgress}%</span>
                  </div>
                  <Progress value={uploadProgress} className="h-3" />
                  {currentPage !== null && totalPages !== null && (
                    <div className="flex justify-between text-xs text-gray-500">
                      <span>
                        Procesando p√°gina {currentPage} de {totalPages}
                      </span>
                      <span>
                        {totalPages > 0 ? Math.round((currentPage / totalPages) * 100) : 0}% de p√°ginas completadas
                      </span>
                    </div>
                  )}
                  {totalPages !== null && totalPages > 1 && (
                    <div className="bg-gray-100 rounded-lg p-3">
                      <div className="flex items-center justify-between text-sm">
                        <div className="flex items-center space-x-2">
                          <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-primary"></div>
                          <span className="text-gray-700">
                            Dividiendo PDF en {totalPages} p√°ginas individuales
                          </span>
                        </div>
                        {currentPage !== null && (
                          <Badge variant="secondary" className="text-xs">
                            P√°gina actual: {currentPage}
                          </Badge>
                        )}
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>
          </CardContent>
        </Card>

        {/* Pricing Banner - Show when user is on basic plan and has no documents yet */}
        {memoryMode === 'basic' && splitDocuments.length === 0 && (
          <PricingBanner 
            currentPlan={memoryMode}
            onUpgrade={() => setMemoryMode('enterprise')}
          />
        )}

        {/* Documents Grid */}
        {splitDocuments.length > 0 && (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <h2 className="text-2xl font-bold text-gray-900">
                Documentos Procesados ({splitDocuments.length})
              </h2>
              <div className="flex space-x-3">
                <Button
                  onClick={processBatchWithClaude}
                  disabled={isBatchProcessing || splitDocuments.filter(d => !d.claudeProcessed).length === 0}
                  className="gradient-primary text-white"
                >
                  {isBatchProcessing ? (
                    <>
                      <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                      Procesando {batchProgress}%
                    </>
                  ) : (
                    <>
                      <Brain className="mr-2 h-4 w-4" />
                      Procesar Todos con IA
                    </>
                  )}
                </Button>
                <Button
                  onClick={exportToExcel}
                  disabled={isExportingExcel || splitDocuments.filter(d => d.claudeProcessed).length === 0}
                  variant="outline"
                  className="border-green-600 text-green-600 hover:bg-green-50"
                >
                  {isExportingExcel ? (
                    <>
                      <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                      Exportando...
                    </>
                  ) : (
                    <>
                      <FileSpreadsheet className="mr-2 h-4 w-4" />
                      Exportar a Excel
                    </>
                  )}
                </Button>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {splitDocuments.map((doc) => (
                <Card 
                  key={doc.id} 
                  className={`shadow-soft card-hover ${
                    doc.claudeProcessed ? 'border-green-200 bg-green-50/50' : ''
                  }`}
                >
                  <CardHeader>
                    <div className="flex justify-between items-start">
                      <div className="flex-1">
                        <CardTitle className="text-lg flex items-center space-x-2">
                          <FileText className="h-5 w-5 text-gray-600" />
                          <span className="truncate">{doc.filename}</span>
                        </CardTitle>
                        <CardDescription className="mt-1">
                          P√°gina {doc.pageNumber}
                        </CardDescription>
                      </div>
                      {doc.claudeProcessed && (
                        <Badge className="gradient-success text-white">
                          <CheckCircle className="h-3 w-3 mr-1" />
                          Procesado
                        </Badge>
                      )}
                    </div>
                  </CardHeader>
                  <CardContent>
                    {doc.claudeProcessed && doc.nominaData && (
                      <div className="mb-4 p-4 bg-white rounded-lg border border-gray-200 space-y-2">
                        <div className="flex justify-between items-center">
                          <span className="text-sm text-gray-600">Empleado:</span>
                          <span className="text-sm font-medium">{doc.nominaData.employee?.name || 'N/A'}</span>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="text-sm text-gray-600">Periodo:</span>
                          <span className="text-sm font-medium">
                            {doc.nominaData.period_start || 'N/A'} - {doc.nominaData.period_end || 'N/A'}
                          </span>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="text-sm text-gray-600">Neto a pagar:</span>
                          <span className="text-sm font-bold text-green-600">
                            ‚Ç¨{doc.nominaData.net_pay ? doc.nominaData.net_pay.toFixed(2) : '0.00'}
                          </span>
                        </div>
                      </div>
                    )}
                    
                    <div className="flex flex-wrap gap-2">
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => openViewer(doc)}
                        className="flex-1"
                      >
                        <Eye className="mr-1 h-4 w-4" />
                        Ver
                      </Button>
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => downloadFile(doc.pdfUrl, doc.filename)}
                        className="flex-1"
                      >
                        <Download className="mr-1 h-4 w-4" />
                        PDF
                      </Button>
                      {!doc.claudeProcessed && (
                        <Button
                          size="sm"
                          onClick={() => processWithClaude(doc)}
                          disabled={isProcessingClaude === doc.id}
                          className="flex-1 gradient-primary text-white"
                        >
                          {isProcessingClaude === doc.id ? (
                            <Loader2 className="h-4 w-4 animate-spin" />
                          ) : (
                            <>
                              <Brain className="mr-1 h-4 w-4" />
                              Procesar
                            </>
                          )}
                        </Button>
                      )}
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>
          </div>
        )}

        {/* Show pricing banner after processing some documents with basic plan */}
        {memoryMode === 'basic' && splitDocuments.length > 2 && (
          <div className="mt-12">
            <PricingBanner 
              currentPlan={memoryMode}
              onUpgrade={() => setMemoryMode('enterprise')}
            />
          </div>
        )}

        {/* Memory Insights Section */}
        {memoryMode === 'enterprise' && memoryStatus && generateBusinessInsights(memoryStatus).length > 0 && (
          <div className="mt-12">
            <h2 className="text-2xl font-bold text-gray-900 mb-6 flex items-center space-x-3">
              <Sparkles className="h-6 w-6 text-purple-600" />
              <span>Insights de tu Memoria Empresarial</span>
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {generateBusinessInsights(memoryStatus).map((insight, index) => (
                <Card key={index} className="shadow-soft card-hover border-purple-200 bg-gradient-to-br from-purple-50 to-primary/10">
                  <CardHeader>
                    <div className="flex items-start space-x-4">
                      <div className="text-4xl">{insight.icon}</div>
                      <div className="flex-1">
                        <CardTitle className="text-lg">{insight.title}</CardTitle>
                        <CardDescription className="mt-2">
                          {insight.description}
                        </CardDescription>
                      </div>
                    </div>
                  </CardHeader>
                  <CardContent>
                    <div className="space-y-3">
                      <div className="flex items-center justify-between p-3 bg-white rounded-lg">
                        <span className="text-sm text-gray-600">{insight.details}</span>
                        <Badge variant="secondary" className="font-bold">
                          {insight.value}
                        </Badge>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>
          </div>
        )}
      </main>

      {/* Floating Help Button */}
      {splitDocuments.length > 0 && (
        <div className="fixed bottom-6 right-6 z-50">
          <div className="flex flex-col space-y-3">
            {/* Quick Stats */}
            <Card className="p-4 shadow-lg bg-white/95 backdrop-blur-sm">
              <div className="text-center">
                <p className="text-xs text-gray-500 mb-1">Progreso</p>
                <div className="flex items-center space-x-2">
                  <div className="text-sm font-medium text-green-600">
                    {splitDocuments.filter(d => d.claudeProcessed).length}
                  </div>
                  <div className="text-xs text-gray-400">/</div>
                  <div className="text-sm font-medium text-gray-600">
                    {splitDocuments.length}
                  </div>
                </div>
                <p className="text-xs text-gray-500">procesados</p>
              </div>
            </Card>
            
            {/* Memory indicator */}
            {memoryMode === 'enterprise' && (
              <Card className="p-3 shadow-lg bg-gradient-to-r from-purple-500 to-primary text-white">
                <div className="text-center">
                  <Brain className="h-4 w-4 mx-auto mb-1" />
                  <p className="text-xs font-medium">Memoria Activa</p>
                </div>
              </Card>
            )}
          </div>
        </div>
      )}

      {/* Footer */}
      <footer className="bg-white border-t border-gray-200 mt-16">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
            {/* Company Info */}
            <div className="col-span-1 md:col-span-2">
              <div className="flex items-center space-x-2 mb-4">
                <FileSpreadsheet className="h-8 w-8 text-primary" />
                <h3 className="text-xl font-bold text-gray-900">Vacly N√≥minas</h3>
              </div>
              <p className="text-gray-600 mb-4">
                Sistema inteligente de gesti√≥n de n√≥minas con IA. Procesa, extrae y gestiona 
                datos de n√≥minas de forma autom√°tica y precisa.
              </p>
              <div className="flex space-x-4">
                <Badge className="bg-primary/10 text-primary">
                  <Shield className="h-3 w-3 mr-1" />
                  Seguro
                </Badge>
                <Badge className="bg-green-100 text-green-800">
                  <Zap className="h-3 w-3 mr-1" />
                  R√°pido
                </Badge>
                <Badge className="bg-purple-100 text-purple-800">
                  <Brain className="h-3 w-3 mr-1" />
                  Inteligente
                </Badge>
              </div>
            </div>

            {/* Features */}
            <div>
              <h4 className="text-sm font-semibold text-gray-900 uppercase tracking-wider mb-4">
                Caracter√≠sticas
              </h4>
              <ul className="space-y-2 text-sm text-gray-600">
                <li>Procesamiento autom√°tico</li>
                <li>Memoria empresarial</li>
                <li>Exportaci√≥n a Excel</li>
                <li>Reconocimiento de patrones</li>
                <li>B√∫squeda inteligente</li>
              </ul>
            </div>

            {/* Plans */}
            <div>
              <h4 className="text-sm font-semibold text-gray-900 uppercase tracking-wider mb-4">
                Planes
              </h4>
              <ul className="space-y-2 text-sm text-gray-600">
                <li>Plan B√°sico - Gratis</li>
                <li>Memoria Empresarial - Premium</li>
                <li>Soporte 24/7</li>
                <li>API Personalizada</li>
              </ul>
            </div>
          </div>

          <div className="border-t border-gray-200 pt-8 mt-8">
            <div className="flex flex-col md:flex-row justify-between items-center">
              <p className="text-sm text-gray-500">
                ¬© 2024 Vacly N√≥minas. Todos los derechos reservados.
              </p>
              <div className="flex items-center space-x-6 mt-4 md:mt-0">
                <Badge variant="outline" className="text-xs">
                  <Award className="h-3 w-3 mr-1" />
                  Cumple RGPD
                </Badge>
                <Badge variant="outline" className="text-xs">
                  <Lock className="h-3 w-3 mr-1" />
                  Cifrado SSL
                </Badge>
              </div>
            </div>
          </div>
        </div>
      </footer>

      {/* Viewer Dialog */}
      <Dialog open={isViewerOpen} onOpenChange={setIsViewerOpen}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-hidden">
          <DialogHeader>
            <DialogTitle className="flex items-center justify-between">
              <span>{viewerDocument?.filename} - P√°gina {viewerDocument?.pageNumber}</span>
              <div className="flex items-center space-x-2">
                <Button
                  size="sm"
                  variant={viewMode === 'pdf' ? 'default' : 'outline'}
                  onClick={() => setViewMode('pdf')}
                >
                  <FileImage className="mr-1 h-4 w-4" />
                  PDF
                </Button>
                <Button
                  size="sm"
                  variant={viewMode === 'text' ? 'default' : 'outline'}
                  onClick={() => setViewMode('text')}
                >
                  <Type className="mr-1 h-4 w-4" />
                  Texto
                </Button>
              </div>
            </DialogTitle>
          </DialogHeader>
          <div className="mt-4 overflow-auto max-h-[calc(90vh-120px)]">
            {viewMode === 'pdf' ? (
              <iframe
                src={viewerDocument?.pdfUrl}
                className="w-full h-[800px] border rounded"
                title="PDF Viewer"
              />
            ) : (
              <div className="p-4 bg-gray-50 rounded-lg">
                <pre className="whitespace-pre-wrap text-sm font-mono">
                  {viewerDocument?.textContent}
                </pre>
              </div>
            )}
          </div>
        </DialogContent>
      </Dialog>

      {/* Memory Configuration Dialog */}
      {memoryMode === 'enterprise' && (
        <Dialog open={showMemoryConfig} onOpenChange={setShowMemoryConfig}>
          <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
            <DialogHeader>
              <DialogTitle className="text-2xl flex items-center space-x-3">
                <Brain className="h-6 w-6 text-purple-600" />
                <span>Configuraci√≥n de Memoria Empresarial</span>
              </DialogTitle>
            </DialogHeader>
            
            <div className="mt-6 space-y-6">
              {isLoadingMemory ? (
                <div className="flex items-center justify-center py-12">
                  <Loader2 className="h-8 w-8 animate-spin text-purple-600" />
                </div>
              ) : memoryStatus ? (
                <>
                  {/* Summary Stats */}
                  <div className="grid grid-cols-3 gap-4">
                    <Card className="bg-gradient-to-br from-primary/10 to-indigo-50">
                      <CardHeader className="pb-3">
                        <CardTitle className="text-sm font-medium text-gray-600">
                          Documentos Procesados
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <p className="text-2xl font-bold text-primary">
                          {memoryStatus.summary?.total_processed || 0}
                        </p>
                      </CardContent>
                    </Card>
                    
                    <Card className="bg-gradient-to-br from-purple-50 to-pink-50">
                      <CardHeader className="pb-3">
                        <CardTitle className="text-sm font-medium text-gray-600">
                          Patrones Aprendidos
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <p className="text-2xl font-bold text-purple-600">
                          {memoryStatus.memory_patterns?.length || 0}
                        </p>
                      </CardContent>
                    </Card>
                    
                    <Card className="bg-gradient-to-br from-green-50 to-emerald-50">
                      <CardHeader className="pb-3">
                        <CardTitle className="text-sm font-medium text-gray-600">
                          Precisi√≥n Promedio
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <p className="text-2xl font-bold text-green-600">
                          {Math.round((memoryStatus.summary?.avg_confidence || 0.5) * 100)}%
                        </p>
                      </CardContent>
                    </Card>
                  </div>

                  {/* Memory Patterns */}
                  {memoryStatus.memory_patterns && memoryStatus.memory_patterns.length > 0 && (
                    <div>
                      <h3 className="text-lg font-semibold mb-4 flex items-center space-x-2">
                        <Hash className="h-5 w-5 text-gray-600" />
                        <span>Patrones Reconocidos</span>
                      </h3>
                      <div className="space-y-3">
                        {memoryStatus.memory_patterns.slice(0, 5).map((pattern: any, index: number) => (
                          <Card key={index} className="shadow-sm">
                            <CardContent className="p-4">
                              <div className="flex justify-between items-start">
                                <div className="flex-1">
                                  <p className="font-medium text-gray-900">
                                    {pattern.extracted_data?.company?.name || 'Empresa sin nombre'}
                                  </p>
                                  <p className="text-sm text-gray-600 mt-1">
                                    Empleado: {pattern.extracted_data?.employee?.name || 'N/A'}
                                  </p>
                                  <div className="flex flex-wrap gap-1 mt-2">
                                    {pattern.keywords?.slice(0, 3).map((keyword: string, kidx: number) => (
                                      <Badge key={kidx} variant="secondary" className="text-xs">
                                        {keyword}
                                      </Badge>
                                    )) || null}
                                  </div>
                                </div>
                                <Button
                                  size="sm"
                                  variant="ghost"
                                  onClick={() => deleteMemoryData('pattern', pattern.id)}
                                  disabled={isDeletingMemory}
                                  className="text-red-600 hover:text-red-700"
                                >
                                  <AlertCircle className="h-4 w-4" />
                                </Button>
                              </div>
                            </CardContent>
                          </Card>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Danger Zone */}
                  <div className="border-t pt-6">
                    <h3 className="text-lg font-semibold mb-4 text-red-600 flex items-center space-x-2">
                      <AlertCircle className="h-5 w-5" />
                      <span>Zona de Peligro</span>
                    </h3>
                    <div className="space-y-3">
                      <Button
                        variant="outline"
                        onClick={() => deleteMemoryData('patterns')}
                        disabled={isDeletingMemory}
                        className="w-full justify-start text-orange-600 border-orange-600 hover:bg-orange-50"
                      >
                        Eliminar todos los patrones aprendidos
                      </Button>
                      <Button
                        variant="outline"
                        onClick={() => deleteMemoryData('embeddings')}
                        disabled={isDeletingMemory}
                        className="w-full justify-start text-orange-600 border-orange-600 hover:bg-orange-50"
                      >
                        Eliminar √≠ndice de b√∫squeda sem√°ntica
                      </Button>
                      <Button
                        variant="outline"
                        onClick={() => deleteMemoryData('all')}
                        disabled={isDeletingMemory}
                        className="w-full justify-start text-red-600 border-red-600 hover:bg-red-50"
                      >
                        Eliminar TODA la memoria empresarial
                      </Button>
                    </div>
                  </div>
                </>
              ) : (
                <div className="text-center py-12">
                  <Brain className="h-16 w-16 text-gray-300 mx-auto mb-4" />
                  <p className="text-gray-600">No hay datos de memoria disponibles</p>
                  <p className="text-sm text-gray-500 mt-2">
                    Procesa algunos documentos para comenzar a construir tu memoria empresarial
                  </p>
                </div>
              )}
            </div>
          </DialogContent>
        </Dialog>
      )}
    </div>
  )
}
